parameters:
- name: OS
  type: string
  default:
- name: Arch
  type: string
  default: 
- name: ArtifactName
  type: string

steps:
- task: DownloadPipelineArtifact@2
  inputs:
    source: 'specific'
    project: 'ae14e11c-7eb2-46af-b588-471e6116d635'
    pipeline: 500
    runVersion: 'latest'
    targetPath: '$(Pipeline.Workspace)'
- task: CmdLine@2
  displayName: 'Build RPM distribution'
  inputs:
    script: release/linux/rpm/pipeline.sh
    workingDirectory: $(Build.SourcesCliDirectory)
  env:
    BUILD_OUTPUT: $(Pipeline.Workspace)
    BUILD_STAGINGDIRECTORY: $(Build.ArtifactStagingDirectory)
- task: EsrpCodeSigning@1
  inputs:
    ConnectedServiceName: 'Code Signing'
    FolderPath: $(Build.ArtifactStagingDirectory)
    Pattern: '*.rpm'
    signConfigType: 'inlineSignParams'
    inlineOperation: |
      [
        {
          "KeyCode" : "CP-450779-Pgp",
          "OperationCode" : "LinuxSign",
          "Parameters" : {},
          "ToolName" : "sign",
          "ToolVersion" : "1.0"
        }
      ]
    SessionTimeout: '600'
    MaxConcurrency: '50'
    MaxRetryAttempts: '20'
- task: PublishPipelineArtifact@0
  displayName: 'Publish Artifact: rpm'
  inputs:
    targetPath: $(Build.ArtifactStagingDirectory)
    artifactName: rpm
- task: DownloadPipelineArtifact@1
  displayName: 'Download rpm artifact'
  inputs:
    TargetPath: $(Build.ArtifactStagingDirectory)/rpm
    artifactName: rpm
- task: CmdLine@2
  displayName: 'Test Linux distributions via yum|zypper'
  inputs:
    script: release/linux/rpm/pipeline-test.sh
    workingDirectory: $(Build.SourcesCliDirectory)
  env:
    BUILD_STAGINGDIRECTORY: $(Build.ArtifactStagingDirectory)

