# sqlcmd release artifacts

trigger: 
  tags:
    include:
      - v0.*

pr: none

variables:
  VERSION: '0.0.1'
  Build.SourcesCliDirectory: '$(Build.SourcesDirectory)/'
  skip.upload: "true"

stages:
  - stage: Compile
    displayName: Compile sqlcmd on platforms
    jobs:
    - job: Compile_sqlcmd
      strategy:
        matrix:
          linux:
            imageName: 'ubuntu-latest'
      pool:
        vmImage: $(imageName)
      steps:
        - template: build-common.yml

  - stage: DebianBuster
    jobs:
    - job: DebianBusterDistribution
      displayName: 'Build Debian Buster distribution'
      condition: succeeded()
      pool:
        vmImage: 'ubuntu-20.04'
      steps:
      - task: DownloadPipelineArtifact@2
        inputs:
          buildType: 'current'
          targetPath: '$(Pipeline.Workspace)'
      - task: CmdLine@2
        displayName: 'Build Debian Buster distribution'
        inputs:
          script: release/linux/debian/pipeline.sh
          workingDirectory: $(Build.SourcesCliDirectory)
        env:
          DISTRO: buster
          DISTRO_BASE_IMAGE: debian
          BUILD_STAGINGDIRECTORY: $(Build.ArtifactStagingDirectory)
    # Temporarily disable code signing to unblock SQLCMD CLI build pipeline
    #  - task: EsrpCodeSigning@1
    #    inputs:
    #      ConnectedServiceName: 'Code Signing'
    #      FolderPath: $(Build.ArtifactStagingDirectory)
    #      Pattern: '*.deb'
    #      signConfigType: 'inlineSignParams'
    #      inlineOperation: |
    #        [
    #          {
    #            "KeyCode" : "CP-450779-Pgp",
    #            "OperationCode" : "LinuxSign",
    #            "Parameters" : {},
    #            "ToolName" : "sign",
    #            "ToolVersion" : "1.0"
    #          }
    #        ]
    #      SessionTimeout: '600'
    #      MaxConcurrency: '50'
    #      MaxRetryAttempts: '20'
      #- task: CodeSignValidationInjected@1
      #  inputs:
      #    Targets: '.deb'
      - task: PublishPipelineArtifact@0
        displayName: 'Publish Artifact: debian-buster'
        inputs:
          TargetPath: $(Build.ArtifactStagingDirectory)
          ArtifactName: debian-buster

  - stage: TestLinuxDebianDistributions
    jobs:
    - job: TestLinuxDebianDistributions
      displayName: 'Test debian packages: apt'

      pool:
        vmImage: 'ubuntu-20.04'
      steps:
      - task: DownloadPipelineArtifact@1
        displayName: 'Download debian-buster artifact'
        inputs:
          TargetPath: $(Build.ArtifactStagingDirectory)/debian
          artifactName: debian-buster
      - task: CmdLine@2
        displayName: 'Test Linux distributions via apt'
        inputs:
          script: release/debian/pipeline-test.sh
          workingDirectory: $(Build.SourcesCliDirectory)
        env:
          BUILD_STAGINGDIRECTORY: $(Build.ArtifactStagingDirectory)
